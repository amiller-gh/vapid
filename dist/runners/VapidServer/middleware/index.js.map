{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/runners/VapidServer/middleware/index.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,2CAA6B;AAC7B,wEAAqC;AACrC,wDAA4B;AAC5B,sDAA6B;AAC7B,sDAA8B;AAE9B,4DAAiC;AACjC,8DAA+B;AAC/B,8DAAkC;AAClC,wDAAgC;AAChC,wEAAgD;AAChD,sDAA8B;AAC9B,wDAAgC;AAEhC,MAAM,qBAAqB,GAAG,IAAI,GAAG,CAAC,CAAE,GAAG,EAAE,GAAG,CAAE,CAAC,CAAA;AAEnD,kBAAe;IACb,MAAM,EAAN,gBAAM;IACN,IAAI,EAAE,IAAI,kBAAI,CAAC;QACb,2BAA2B,EAAE,wBAAwB;QACrD,8BAA8B,EAAE,GAAG;QACnC,mBAAmB,EAAE,oBAAoB;QACzC,sBAAsB,EAAE,GAAG;QAC3B,eAAe,EAAE,CAAC,KAAK,EAAE,MAAM,EAAE,SAAS,CAAC;QAC3C,YAAY,EAAE,KAAK;KACpB,CAAC;IACF,OAAO,EAAP,iBAAO;IACP,KAAK,EAAE,0BAAK,EAAE;IACd,eAAe,EAAf,yBAAe;IACf,IAAI,EAAE,iBAAM,CAAC,MAAM,CAAC;IAEpB,4DAA4D;IAC5D,YAAY,EAAE,SAAe,YAAY,CAAC,GAAgB,EAAE,IAAyB;;YACnF,IAAI,qBAAqB,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE;gBACzD,MAAM,cAAI,CAAC,QAAQ,CAAC,oFAAoF,CAAC,CAAC;aAC3G;YACD,MAAM,IAAI,EAAE,CAAC;QACf,CAAC;KAAA;IAED,iCAAiC;IACjC,QAAQ,EAAE,CAAO,GAAgB,EAAE,IAAyB,EAAE,EAAE;QAC9D,sBAAsB;QACtB,MAAM,EAAE,QAAQ,EAAE,GAAG,GAAG,CAAC;QAEzB,GAAG,CAAC,QAAQ,GAAG,CAAC,GAAW,EAAE,GAAW,EAAE,EAAE;YAC1C,GAAG,CAAC,GAAG,CAAC,qBAAqB,EAAE,GAAG,CAAC,CAAC;YACpC,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC;QAClC,CAAC,CAAC;QAEF,MAAM,IAAI,EAAE,CAAC;IACf,CAAC,CAAA;IACD,QAAQ,EAAE,oBAAM,EAAE;IAClB,OAAO,EAAE,CAAC,GAAQ,EAAE,EAAE,CAAC,qBAAO,CAAC,qBAAI,CAAC,GAAG,EAAE,EAAE,GAAG,EAAE,YAAY,EAAE,CAAC,CAAC;IAChE,OAAO,EAAP,iBAAO;CACR,CAAA","sourcesContent":["import * as path from 'path';\nimport flash from 'koa-better-flash';\nimport CSRF from 'koa-csrf';\nimport koaLog from 'koa-log';\nimport Boom from '@hapi/boom';\nimport Koa from 'koa';\nimport helmet  from 'koa-helmet';\nimport sess from 'koa-session';\nimport convert from 'koa-convert';\nimport webpack from './webpack';\nimport imageProcessing from './imageProcessing';\nimport assets from './assets';\nimport favicon from './favicon';\n\nconst PRIVATE_FILE_PREFIXES = new Set([ '_', '.' ])\n\nexport default {\n  assets,\n  csrf: new CSRF({\n    invalidSessionSecretMessage: 'Invalid session secret',\n    invalidSessionSecretStatusCode: 403,\n    invalidTokenMessage: 'Invalid CSRF token',\n    invalidTokenStatusCode: 403,\n    excludedMethods: ['GET', 'HEAD', 'OPTIONS'],\n    disableQuery: false,\n  }),\n  favicon,\n  flash: flash(),\n  imageProcessing,\n  logs: koaLog('tiny'),\n\n  // Throw 404 if the path starts with an underscore or period\n  privateFiles: async function privateFiles(ctx: Koa.Context, next: () => Promise<void>) {\n    if (PRIVATE_FILE_PREFIXES.has(path.basename(ctx.path)[0])) {\n      throw Boom.notFound('Filenames starting with an underscore or period are private, and cannot be served.');\n    }\n    await next();\n  },\n\n  // Custom redirect for turbolinks\n  redirect: async (ctx: Koa.Context, next: () => Promise<void>) => {\n    // Override ctx.render\n    const { redirect } = ctx;\n  \n    ctx.redirect = (url: string, alt: string) => {\n      ctx.set('Turbolinks-Location', url);\n      redirect.apply(ctx, [url, alt]);\n    };\n  \n    await next();\n  },\n  security: helmet(),\n  session: (app: any) => convert(sess(app, { key: 'vapid:sess' })),\n  webpack,\n}\n"]}