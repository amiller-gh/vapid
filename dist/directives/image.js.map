{"version":3,"file":"image.js","sourceRoot":"","sources":["../../lib/directives/image.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport { imageSize } from 'image-size';\n\nimport { BaseDirective } from './base';\n\nconst enum ImageType {\n  JPEG = 'jpeg',\n  PNG = 'png',\n  SVG = 'svg',\n  GIF = 'gif',\n}\ninterface ImageDirectiveValue {\n  src: string;\n  type: ImageType;\n  width: number;\n  height: number;\n  aspectRatio: number;\n}\n\nexport default class ImageDirective extends BaseDirective<ImageDirectiveValue> {\n\n  options = {\n    default: {\n      src: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',\n      type: ImageType.GIF,\n      width: 1,\n      height: 1,\n      aspectRatio: 1,\n    },\n    label: '',\n    help: '',\n    priority: 0,\n  }\n\n  attrs = {\n    required: false,\n    placeholder: ''\n  }\n\n  /**\n   * Renders inputs necessary to upload, preview, and optionally remove images\n   *\n   * @param {string} name\n   * @param {string} [value=this.options.default]\n   * @return {string} rendered HTML\n   *\n   * eslint-disable class-methods-use-this\n   */\n  input(name: string, value: ImageDirectiveValue | null = null ) {\n    const inputs = `<input type=\"file\" name=\"${name}\" accept=\"image/*\" >\n                  <input type=\"hidden\" name=\"${name}\" value=\"${value}\">`;\n    const src = value ? `/uploads/${value}` : '';\n    const preview = `<img class=\"preview\" src=\"${src}\" id=\"${name}\">`;\n    const destroyName = name.replace('content', '_destroy');\n    const destroy = !this.attrs.required\n      ? `<div class=\"ui checkbox\">\n            <input type=\"checkbox\" name=\"${destroyName}\" id=\"${destroyName}\">\n            <label for=\"${destroyName}\">Remove</label>\n          </div>`\n      : '';\n\n    return `\n      <div class=\"previewable\">\n        ${inputs}\n        ${preview}\n        ${destroy}\n        <button id=\"edit-image-button\" data-name=\"${name}\">Edit</button>\n      </div>`;\n  }\n\n  /**\n   * Renders <img> tag or raw src\n   */\n  async render(value: ImageDirectiveValue = this.options.default) {\n    const src = value.src?.indexOf('data:') === -1\n      ? `/uploads/${value.src}`\n      : value.src;\n\n    const onDisk =  value.src ? path.join(process.cwd(), 'data/uploads',  value.src) : null;\n    const size = (onDisk && fs.existsSync(onDisk) && imageSize(onDisk)) || { width: 1, height: 1, type: 'gif' };\n\n    return {\n      src,\n      width: size.width,\n      height: size.height,\n      type: size.type,\n      aspectRatio: (size.height && size.width) ? (size.height / size.width) : 1,\n      toString() { return src; }\n    };\n  }\n\n  /**\n   * A preview of the image\n   *\n   * @param {string} fileName\n   * @return {string}\n   */\n  preview(value: ImageDirectiveValue = this.options.default) {\n    const src = value?.src?.indexOf('data:') === -1\n      ? `/uploads/${value.src}`\n      : value.src;\n    return `<img src=\"${src}\" />`;\n  }\n}\n"]}